# Nimbus
# Copyright (c) 2021-2025 Status Research & Development GmbH
# Licensed under either of
#  * Apache License, version 2.0, ([LICENSE-APACHE](LICENSE-APACHE) or
#    http://www.apache.org/licenses/LICENSE-2.0)
#  * MIT license ([LICENSE-MIT](LICENSE-MIT) or
#    http://opensource.org/licenses/MIT)
# at your option. This file may not be copied, modified, or distributed except
# according to those terms.

name: Simulators
on:
  schedule:
    # every two days 11 PM
    - cron: "0 23 */2 * *"
  workflow_dispatch:

jobs:
  matrix_config:
    uses: ./.github/workflows/matrix_config.yml

  build:
    needs: matrix_config

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix_config.outputs.matrix) }}

    defaults:
      run:
        shell: bash

    name: '${{ matrix.os }}-${{ matrix.cpu }}'
    runs-on: ${{ matrix.builder }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: shared-action
        uses: ./.github/actions/shared
        with:
          llvm-mingw: true
          nim-cache: true
          rocksdb-cache: true
          eest-cache: true

      - name: Run Simulators
        run: |
          make -j${ncpu} ROCKSDB_CI_CACHE=RocksBinCache deps rocksdb eest
          SIM_SCRIPT="hive_integration/nodocker/build_sims.sh"
          bash ${SIM_SCRIPT} "${{ matrix.os }}-${{ matrix.cpu }}"

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: '${{ matrix.os }}_${{ matrix.cpu }}_stat'
          path: ./simulators.md
          retention-days: 2

  prepare-stat:
    name: Test results
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Download artefacts
        uses: actions/download-artifact@v4

      - name: Create statistics notes
        run: |
          cat linux_amd64_stat/* > stat_notes.md
          cat linux_arm64_stat/* >> stat_notes.md
          cat macos_arm64_stat/* >> stat_notes.md
          cat windows_amd64_stat/* >> stat_notes.md

      - name: Delete tag
        run: gh release delete $TAG --cleanup-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: sim-stat

      - name: Simulators results
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          prerelease: true
          commit: master
          name: "Simulators results"
          tag: sim-stat
          bodyFile: "stat_notes.md"

      - name: Delete artefacts
        uses: geekyeggo/delete-artifact@v5
        with:
          failOnError: false
          name: |
            linux_arm64_stat
            linux_amd64_stat
            macos_arm64_stat
            windows_amd64_stat
